server {
    listen %%interface%%:%%port%% default_server;
    client_max_body_size 0;
    root /opt/recipes/cookbook;
    
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-NginX-Proxy true;
    proxy_set_header X-Real-IP $remote_addr;
    
    proxy_http_version          1.1;
    proxy_ignore_client_abort   off;
    proxy_read_timeout          86400s;
    proxy_redirect              off;
    proxy_send_timeout          86400s;
    proxy_max_temp_file_size    0;
    
    proxy_set_header Connection $upgrade;
    proxy_set_header Upgrade $http_upgrade;

    proxy_set_header Host $http_host;                   # try $host instead if this doesn't work

    location / {
       proxy_pass http://127.0.0.1:8080;
       proxy_buffering off;
       proxy_read_timeout 30;

       # Allow ingress subpath
       proxy_set_header X-Script-Name %%ingress_entry%%;
       proxy_cookie_path / %%ingress_entry%%/;
       
       # Allow frames
       add_header X-Frame-Options SAMEORIGIN;
       
       # Correct url without port when using https
       sub_filter_once off;
       sub_filter_types *;

       # Rewrite url
       sub_filter "/static" "%%ingress_entry%%/static";
       sub_filter "/media" "%%ingress_entry%%/media";
    }
}
